
<!DOCTYPE html>

<html>
<head>
<title>Bus Scanner Dashboard</title>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<link href="manifest.json" rel="manifest"/>
<meta content="#007bff" name="theme-color"/>
<style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { text-align: center; }
        .bus-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .bus {
            border: 1px solid #ccc; border-radius: 8px; padding: 10px;
            background-color: #f9f9f9; cursor: pointer; transition: background 0.2s;
        }
        .bus:hover { background-color: #e9e9e9; }
        .bus h2 {
            margin-top: 0; font-size: 18px; background: #333; color: white;
            padding: 5px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;
        }
        ul { list-style: none; padding: 0; margin-top: 5px; }
        li { padding: 5px; border-bottom: 1px solid #ddd; }
        .time { color: gray; font-size: 12px; }
        .count-badge {
            background: orange; color: white; padding: 2px 8px; border-radius: 12px; font-size: 14px;
        }
        .back-btn { background-color: #28a745; color: white; padding: 10px 15px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 10px; }
        .back-btn:hover { background-color: #1e7e34; }
        button.action-btn { background:#007bff;color:white;padding:8px 12px;border:none;border-radius:5px;cursor:pointer; }
        button.action-btn.orange { background:orange; }
        #qrArea canvas { margin: 5px; }
    </style>
</head>
<body>
<div style="text-align: left;">
<button class="back-btn" onclick="window.location.href='index.html'">üîô</button>
</div>
<div style="text-align:left; margin: 10px 0;"><button class="action-btn" id="downloadTemplateBtn">‚¨áÔ∏è Download CSV Template</button></div><h1>üöå Bus Boarding Dashboard</h1>
<!-- Control Buttons -->
<div id="busControls" style="display:none; margin-bottom:15px;">
<button class="action-btn" id="uploadBtn">üì§ Upload Attendees</button>
<button class="action-btn orange" id="generateQRBtn">üìÑ Generate QR Codes</button>
</div>
<!-- Hidden file input -->
<input accept=".xlsx, .xls" id="excelFile" style="display:none;" type="file"/>
<div class="bus-container" id="busContainer"></div>
<!-- QR Code display area -->
<div id="qrArea" style="display:none; margin-top:20px;">
<h3>Generated QR Codes</h3>
<div id="qrCodes"></div>
</div>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script><script>
        const firebaseConfig = {
            apiKey: "AIzaSyDSCJUwOe_MxqS_8SPfEmhZ4p_MOigXKyY",
            authDomain: "bus-monitor-7195d.firebaseapp.com",
            projectId: "bus-monitor-7195d",
            storageBucket: "bus-monitor-7195d.firebasestorage.app",
            messagingSenderId: "827570613765",
            appId: "1:827570613765:web:5ed5f2635174e3379f366c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const busContainer = document.getElementById('busContainer');
        const buses = {};
        let selectedBus = null;

        
function createBusSection(busName) {
    const div = document.createElement('div');
    div.className = 'bus';
    div.innerHTML = `
        <h2>${busName} <span class="count-badge" id="${busName}Count">0</span></h2>
        <div style="display:flex; gap:8px; margin:8px 0; flex-wrap:wrap;">
            <input type="file" id="${busName}File" accept=".csv,.xlsx,.xls" style="display:none;" />
            <button class="action-btn" id="${busName}Upload">üì§ Upload Attendees</button>
            <button class="action-btn orange" id="${busName}DownloadQR">üìÑ Download QR Codes</button>
        </div>
        <div style="font-weight:bold; margin-top:6px;">Attendees</div>
        <table style="width:100%; border-collapse: collapse;" id="${busName}AttTable">
            <thead>
                <tr>
                    <th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Name</th>
                    <th style="text-align:left; border-bottom:1px solid #ddd; padding:6px;">Scan Timestamp</th>
                </tr>
            </thead>
            <tbody id="${busName}AttBody">
                <tr><td colspan="2" style="padding:8px; color:#777;">No attendees yet.</td></tr>
            </tbody>
        </table>
        <div style="font-weight:bold; margin-top:12px;">Recent Scans</div>
        <ul id="${busName}List"></ul>
    `;

    // Select bus on click to keep legacy controls working (non-breaking)
    div.addEventListener('click', () => {
        selectedBus = busName;
        const ctrl = document.getElementById('busControls');
        if (ctrl) ctrl.style.display = 'block';
    });

    busContainer.appendChild(div);

    // Wire up per-bus upload
    const uploadBtn = div.querySelector('#' + `${busName}Upload`);
    const fileInput = div.querySelector('#' + `${busName}File`);
    uploadBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const names = await readNamesFromFile(file);
        if (!names.length) { alert("No names found in file. Make sure the first column header is 'Name'."); return; }
        // Write to Firestore under buses/{busName}/attendees/{docId}
        const batch = db.batch();
        const attCol = db.collection('buses').doc(busName).collection('attendees');
        names.forEach(n => {
            const docRef = attCol.doc(n);
            batch.set(docRef, { name: n, timestamp: null }, { merge: true });
        });
        await batch.commit();
        alert(`Uploaded ${names.length} attendees for ${busName}.`);
        fileInput.value = '';
    });

    // Wire up per-bus QR download
    const dlBtn = div.querySelector('#' + `${busName}DownloadQR`);
    dlBtn.addEventListener('click', async () => {
        // Fetch attendees
        const snap = await db.collection('buses').doc(busName).collection('attendees').get();
        if (snap.empty) { alert("No attendees to generate QR codes for."); return; }
        const zip = new JSZip();
        // Temporary container for QR generation
        const temp = document.createElement('div');
        temp.style.position = 'fixed'; temp.style.left = '-9999px'; document.body.appendChild(temp);
        for (const doc of snap.docs) {
            const data = doc.data();
            const wrapper = document.createElement('div');
            temp.appendChild(wrapper);
            const qr = new QRCode(wrapper, { text: data.name, width: 512, height: 512 });
            // Wait a tick for QRCode to render
            await new Promise(r => setTimeout(r, 10));
            const img = wrapper.querySelector('img') || wrapper.querySelector('canvas');
            let dataURL;
            if (img && img.tagName === 'IMG') {
                dataURL = img.src;
            } else if (img && img.tagName === 'CANVAS') {
                dataURL = img.toDataURL('image/png');
            }
            if (dataURL) {
                const base64 = dataURL.split(',')[1];
                zip.file(`${sanitizeFilename(data.name)}.png`, base64, {base64:true});
            }
            wrapper.remove();
        }
        document.body.removeChild(temp);
        const blob = await zip.generateAsync({type:'blob'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${busName}-QR-Codes.zip`;
        document.body.appendChild(a);
        a.click();
        a.remove();
    });

    // Live attendees table
    db.collection('buses').doc(busName).collection('attendees').orderBy('name').onSnapshot(s => {
        const tbody = document.getElementById(`${busName}AttBody`);
        tbody.innerHTML = '';
        if (s.empty) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="2" style="padding:8px; color:#777;">No attendees yet.</td>`;
            tbody.appendChild(tr);
            return;
        }
        s.forEach(doc => {
            const d = doc.data();
            const tr = document.createElement('tr');
            const ts = d.timestamp ? new Date(d.timestamp).toLocaleString() : '';
            tr.innerHTML = `
                <td style="padding:6px; border-bottom:1px solid #eee;">${escapeHtml(d.name)}</td>
                <td style="padding:6px; border-bottom:1px solid #eee;">${ts}</td>
            `;
            tbody.appendChild(tr);
        });
    });
}
        for (let i = 1; i <= 12; i++) {
            const busName = `Bus${i}`;
            createBusSection(busName);
            buses[busName] = {
                list: document.getElementById(`${busName}List`),
                count: document.getElementById(`${busName}Count`)
            };
        }

        // Display scans
        db.collection("scans").orderBy("time", "desc").onSnapshot(snapshot => {
            for (let bus in buses) {
                buses[bus].list.innerHTML = "";
                buses[bus].count.innerText = "0";
            }
            const counts = {};
            snapshot.forEach(doc => {
                const data = doc.data();
                if (buses[data.bus]) {
                    counts[data.bus] = (counts[data.bus] || 0) + 1;
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${data.name}</strong>      
                        <div class="time">${new Date(data.time).toLocaleString()}</div>`;
                    buses[data.bus].list.appendChild(li);
                }
            });
            for (let bus in counts) {
                buses[bus].count.innerText = counts[bus];
            }
        });

        // Upload button
        document.getElementById('uploadBtn').addEventListener('click', () => {
            if (!selectedBus) return alert("Select a bus first!");
            document.getElementById('excelFile').click();
        });

        // Upload passenger list
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file || !selectedBus) return;

            const reader = new FileReader();
            reader.onload = function(ev) {
                const data = new Uint8Array(ev.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const passengers = XLSX.utils.sheet_to_json(sheet);

                passengers.forEach(p => {
                    if (p.code && p.name) {
                        db.collection("passengers").doc(p.code).set({
                            name: p.name,
                            bus: selectedBus
                        });
                    }
                });
                alert(`Passenger list for ${selectedBus} uploaded successfully!`);
                e.target.value = "";
            };
            reader.readAsArrayBuffer(file);
        });

        // Generate QR Codes
        document.getElementById('generateQRBtn').addEventListener('click', async () => {
            if (!selectedBus) return alert("Select a bus first!");
            
            const qrArea = document.getElementById('qrArea');
            const qrCodesDiv = document.getElementById('qrCodes');
            qrCodesDiv.innerHTML = "";
            qrArea.style.display = 'block';

            const snapshot = await db.collection("passengers").where("bus", "==", selectedBus).get();
            if (snapshot.empty) {
                alert("No passengers found for this bus.");
                return;
            }

            snapshot.forEach(doc => {
                const data = doc.data();
                const container = document.createElement('div');
                container.style.display = "inline-block";
                container.style.textAlign = "center";

                const qrDiv = document.createElement('div');
                new QRCode(qrDiv, {
                    text: data.code,
                    width: 100,
                    height: 100
                });

                const label = document.createElement('div');
                label.textContent = data.name;

                container.appendChild(qrDiv);
                container.appendChild(label);
                qrCodesDiv.appendChild(container);
            });
        });
    

async function readNamesFromFile(file) {
    const ext = (file.name.split('.').pop() || '').toLowerCase();
    if (ext === 'csv') {
        const text = await file.text();
        const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
        const rows = lines.map(l => l.split(',').map(c => c.trim()));
        // Expect header "Name" in first cell
        const startIdx = rows[0] && rows[0][0].toLowerCase() === 'name' ? 1 : 0;
        const names = [];
        for (let i = startIdx; i < rows.length; i++) {
            if (rows[i][0]) names.push(rows[i][0]);
        }
        return Array.from(new Set(names)); // de-duplicate
    } else if (ext === 'xlsx' || ext === 'xls') {
        const arrayBuffer = await file.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const firstSheet = workbook.SheetNames[0];
        const sheet = workbook.Sheets[firstSheet];
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        const startIdx = json[0] && String(json[0][0]).toLowerCase() === 'name' ? 1 : 0;
        const names = [];
        for (let i = startIdx; i < json.length; i++) {
            if (json[i][0]) names.push(String(json[i][0]).trim());
        }
        return Array.from(new Set(names));
    } else {
        alert("Unsupported file type. Please upload a .csv or .xlsx file.");
        return [];
    }
}

function sanitizeFilename(name) {
    return name.replace(/[\\/:*?"<>|]+/g, '_').trim() || 'qr';
}
function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, function (m) {
        return ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]);
    });
}

// Top-left template download
document.getElementById('downloadTemplateBtn').addEventListener('click', () => {
    const csv = "Name\nJohn Doe\nJane Smith\n";
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'attendee-template.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
});
</script>
</body>
</html>
