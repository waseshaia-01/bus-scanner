<!DOCTYPE html>
<html>
<head>
    <title>Bus Scanner Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- PWA Manifest and Theme Color -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { text-align: center; margin-top: 0; }
        .bus-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .bus {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            background-color: #f9f9f9;
        }
        .bus h2 {
            margin-top: 0;
            font-size: 18px;
            background: #333;
            color: white;
            padding: 5px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        ul { list-style: none; padding: 0; margin-top: 5px; }
        li { padding: 5px; border-bottom: 1px solid #ddd; }
        .time { color: gray; font-size: 12px; }
        .count-badge {
            background: orange;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 14px;
        }
        /* Back button style */
        .back-btn {
            background-color: #28a745;
            color: white;
            padding: 10px 15px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .back-btn:hover {
            background-color: #1e7e34;
        }
    </style>
</head>
<body>

    <!-- Back button aligned to top-left -->
    <div style="text-align: left; margin-bottom: 5px;">
        <button class="back-btn" onclick="window.location.href='index.html'">üîô</button>
    </div>

    <!-- Dashboard Title -->
    <h1>üöå Bus Boarding Dashboard</h1>

    <div class="bus-container" id="busContainer"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDSCJUwOe_MxqS_8SPfEmhZ4p_MOigXKyY",
            authDomain: "bus-monitor-7195d.firebaseapp.com",
            projectId: "bus-monitor-7195d",
            storageBucket: "bus-monitor-7195d.firebasestorage.app",
            messagingSenderId: "827570613765",
            appId: "1:827570613765:web:5ed5f2635174e3379f366c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Enable offline persistence
        db.enablePersistence()
          .catch(err => {
              if (err.code === 'failed-precondition') {
                  console.warn("‚ö†Ô∏è Persistence failed - multiple tabs open");
              } else if (err.code === 'unimplemented') {
                  console.warn("‚ö†Ô∏è Persistence not available in this browser");
              }
          });

        const busContainer = document.getElementById('busContainer');
        const buses = {};

        function createBusSection(busName) {
            const div = document.createElement('div');
            div.className = 'bus';
            div.innerHTML = `<h2>${busName} <span class="count-badge" id="${busName}Count">0</span></h2><ul id="${busName}List"></ul>`;
            busContainer.appendChild(div);
        }

        // Create sections for Bus1‚ÄìBus12
        for (let i = 1; i <= 12; i++) {
            const busName = `Bus${i}`;
            createBusSection(busName);
            buses[busName] = {
                list: document.getElementById(`${busName}List`),
                count: document.getElementById(`${busName}Count`)
            };
        }

        // Listen for Firestore changes
        db.collection("scans").orderBy("time", "desc").onSnapshot(snapshot => {
            // Reset counts and lists
            for (let bus in buses) {
                buses[bus].list.innerHTML = "";
                buses[bus].count.innerText = "0";
            }

            const counts = {};

            snapshot.forEach(doc => {
                const data = doc.data();
                if (buses[data.bus]) {
                    // Count passengers
                    counts[data.bus] = (counts[data.bus] || 0) + 1;

                    // Add list item
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${data.code}</strong> <div class="time">${new Date(data.time).toLocaleTimeString()}</div>`;
                    buses[data.bus].list.appendChild(li);
                }
            });

            // Update counts
            for (let bus in counts) {
                buses[bus].count.innerText = counts[bus];
            }
        });
    </script>

    <!-- Service Worker Registration -->
    <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("./service-worker.js", { scope: "./" })
          .then(reg => console.log("SW registered:", reg.scope))
          .catch(err => console.log("SW registration failed:", err));
      });
    }
    </script>

</body>
</html>
