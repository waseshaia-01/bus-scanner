<!DOCTYPE html>
<html>
<head>
    <title>Bus QR Scanner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
        #reader { width: 100%; max-width: 400px; margin: auto; }
        select, button { padding: 10px; margin: 5px 0; width: 100%; font-size: 16px; }
        #status { margin-top: 10px; font-weight: bold; }
        .dashboard-btn {
            background-color: #007bff;
            color: white; border: none;
            border-radius: 5px; cursor: pointer;
        }
        .dashboard-btn:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <h2>Bus QR Scanner</h2>
    <button class="dashboard-btn" onclick="window.location.href='dashboard.html'">📊 View Bus Dashboard</button>

    <label for="busSelect">Select Bus:</label>
    <select id="busSelect">
        <option value="">-- Select Bus --</option>
        <option value="Bus1">Bus 1</option>
        <option value="Bus2">Bus 2</option>
        <option value="Bus3">Bus 3</option>
        <option value="Bus4">Bus 4</option>
        <option value="Bus5">Bus 5</option>
        <option value="Bus6">Bus 6</option>
        <option value="Bus7">Bus 7</option>
        <option value="Bus8">Bus 8</option>
        <option value="Bus9">Bus 9</option>
        <option value="Bus10">Bus 10</option>
        <option value="Bus11">Bus 11</option>
        <option value="Bus12">Bus 12</option>
    </select>

    <div id="reader"></div>
    <div id="status"></div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDSCJUwOe_MxqS_8SPfEmhZ4p_MOigXKyY",
            authDomain: "bus-monitor-7195d.firebaseapp.com",
            projectId: "bus-monitor-7195d",
            storageBucket: "bus-monitor-7195d.firebasestorage.app",
            messagingSenderId: "827570613765",
            appId: "1:827570613765:web:5ed5f2635174e3379f366c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const busSelect = document.getElementById("busSelect");
        const statusDiv = document.getElementById("status");

        async function logScan(qrMessage) {
            const bus = busSelect.value;
            if (!bus) {
                alert("Please select a bus first!");
                return;
            }

            try {
                // Check passenger in uploaded list
                const passengerRef = await db.collection("passengers").doc(qrMessage).get();
                if (!passengerRef.exists) {
                    statusDiv.style.color = "red";
                    statusDiv.innerText = "❌ Passenger not in uploaded list.";
                    return;
                }
                const passenger = passengerRef.data();

                if (passenger.bus !== bus) {
                    statusDiv.style.color = "red";
                    statusDiv.innerText = `❌ ${passenger.name} is assigned to ${passenger.bus}, not ${bus}.`;
                    return;
                }

                // Check if already scanned
                const existingScan = await db.collection("scans")
                    .where("bus", "==", bus)
                    .where("code", "==", qrMessage)
                    .get();

                if (!existingScan.empty) {
                    statusDiv.style.color = "orange";
                    statusDiv.innerText = `⚠️ ${passenger.name} already scanned for ${bus}.`;
                    return;
                }

                // Save scan
                await db.collection("scans").add({
                    bus,
                    code: qrMessage,
                    name: passenger.name,
                    uploadedListName: passenger.uploadedListName || "Unknown List",
                    time: new Date().toISOString(),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                statusDiv.style.color = "green";
                statusDiv.innerText = `✅ ${passenger.name} boarded ${bus}`;
            } catch (err) {
                statusDiv.style.color = "red";
                statusDiv.innerText = "❌ Error: " + err.message;
            }
        }

        function onScanSuccess(decodedText) {
            logScan(decodedText);
        }

        const html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            onScanSuccess
        ).catch(err => {
            console.error("Unable to start scanning:", err);
        });
    </script>
</body>
</html>
