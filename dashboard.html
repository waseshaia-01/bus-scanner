<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Attendees Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const busesContainer = document.getElementById('busesContainer');

        const busNames = [
            "Bus 1", "Bus 2", "Bus 3", "Bus 4", "Bus 5", "Bus 6",
            "Bus 7", "Bus 8", "Bus 9", "Bus 10", "Bus 11", "Bus 12"
        ];

        busNames.forEach(busName => {
            const busSection = document.createElement('div');
            busSection.classList.add('bus-section');

            const header = document.createElement('div');
            header.classList.add('bus-header');
            header.textContent = busName;

            const attendeesList = document.createElement('ul');
            attendeesList.classList.add('attendees-list');
            attendeesList.style.display = 'none';

            header.addEventListener('click', () => {
                attendeesList.style.display = attendeesList.style.display === 'none' ? 'block' : 'none';
            });

            busSection.appendChild(header);
            busSection.appendChild(attendeesList);
            busesContainer.appendChild(busSection);

            const q = query(collection(db, "buses", busName, "attendees"), orderBy("scannedAt", "desc"));
            onSnapshot(q, (snapshot) => {
                attendeesList.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const li = document.createElement('li');
                    li.textContent = `${data.name} (${data.code}) - ${data.scannedAt ? new Date(data.scannedAt.seconds * 1000).toLocaleString() : 'Not scanned'}`;
                    attendeesList.appendChild(li);
                });
            });
        });

        // Expand/Collapse all buses
        document.getElementById('toggleAllBtn').addEventListener('click', function () {
            const allLists = document.querySelectorAll('.attendees-list');
            const expand = this.textContent === 'Expand All';
            allLists.forEach(list => list.style.display = expand ? 'block' : 'none');
            this.textContent = expand ? 'Collapse All' : 'Expand All';
        });

        // ---- Download Excel Template ----
        document.getElementById('downloadTemplateBtn').addEventListener('click', function () {
            const wb = XLSX.utils.book_new();
            const ws_data = [["code", "name"]]; // Header row
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Template");

            XLSX.writeFile(wb, "passenger_template.xlsx");
        });
    </script>
</head>
<body>
    <div id="topBar">
        <button id="toggleAllBtn" class="toggle-btn">Expand All</button>
        <button id="downloadTemplateBtn" class="action-btn">⬇️ Download Template</button>
    </div>
    <div id="busesContainer"></div>
</body>
</html>
