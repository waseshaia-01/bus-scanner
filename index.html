<!DOCTYPE html>
<html>
<head>
    <title>Bus QR Scanner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- PWA Manifest and Theme Color -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
        #reader { width: 100%; max-width: 400px; margin: auto; }
        select, button { padding: 10px; margin: 5px 0; width: 100%; font-size: 16px; }
        #status { margin-top: 10px; font-weight: bold; color: green; }
        .dashboard-btn {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .dashboard-btn:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h2>Bus QR Scanner</h2>

    <!-- Dashboard Button -->
    <button class="dashboard-btn" onclick="window.location.href='dashboard.html'">
        üìä View Bus Dashboard
    </button>

    <label for="busSelect">Select Bus:</label>
    <select id="busSelect">
        <option value="">-- Select Bus --</option>
        <option value="Bus1">Bus 1</option>
        <option value="Bus2">Bus 2</option>
        <option value="Bus3">Bus 3</option>
        <option value="Bus4">Bus 4</option>
        <option value="Bus5">Bus 5</option>
        <option value="Bus6">Bus 6</option>
        <option value="Bus7">Bus 7</option>
        <option value="Bus8">Bus 8</option>
        <option value="Bus9">Bus 9</option>
        <option value="Bus10">Bus 10</option>
        <option value="Bus11">Bus 11</option>
        <option value="Bus12">Bus 12</option>
    </select>

    <div id="reader"></div>
    <div id="status"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- QR Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode"></script>

    <script>
        // Your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDSCJUwOe_MxqS_8SPfEmhZ4p_MOigXKyY",
            authDomain: "bus-monitor-7195d.firebaseapp.com",
            projectId: "bus-monitor-7195d",
            storageBucket: "bus-monitor-7195d.firebasestorage.app",
            messagingSenderId: "827570613765",
            appId: "1:827570613765:web:5ed5f2635174e3379f366c"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Enable offline persistence
        db.enablePersistence()
          .catch(err => {
              if (err.code == 'failed-precondition') {
                  console.warn("‚ö†Ô∏è Persistence failed - multiple tabs open");
              } else if (err.code == 'unimplemented') {
                  console.warn("‚ö†Ô∏è Persistence not available in this browser");
              }
          });

        const busSelect = document.getElementById("busSelect");
        const statusDiv = document.getElementById("status");

        function logScan(qrMessage) {
            const bus = busSelect.value;
            if (!bus) {
                alert("Please select a bus first!");
                return;
            }

            // Check if this QR code has already been scanned for the same bus
            db.collection("scans")
              .where("bus", "==", bus)
              .where("code", "==", qrMessage)
              .get()
              .then(snapshot => {
                  if (!snapshot.empty) {
                      statusDiv.innerText = "‚ö†Ô∏è This QR code has already been scanned for " + bus;
                      return;
                  }

                  // Save new scan (works offline too, will sync later)
                  db.collection("scans").add({
                      bus: bus,
                      code: qrMessage,
                      time: new Date().toISOString()
                  }).then(() => {
                      statusDiv.innerText = "‚úÖ Saved: " + qrMessage + " to " + bus;
                  }).catch(err => {
                      statusDiv.innerText = "‚ùå Error: " + err;
                  });
              })
              .catch(err => {
                  console.error("Error checking duplicates: ", err);
                  statusDiv.innerText = "‚ùå Error checking duplicates: " + err;
              });
        }

        function onScanSuccess(decodedText) {
            logScan(decodedText);
        }

        const html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", { fps: 10, qrbox: 250 });
        html5QrcodeScanner.render(onScanSuccess);
    </script>

    <!-- Service Worker Registration -->
    <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("./service-worker.js", { scope: "./" })
          .then(reg => console.log("SW registered:", reg.scope))
          .catch(err => console.log("SW registration failed:", err));
      });
    }
    </script>
</body>
</html>
