
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bus QR Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#007bff" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; background:#f7f7fb; }
    h1 { text-align:center; margin-bottom: 10px; }
    .toolbar { display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap; margin: 14px 0 20px; }
    select, button { padding:10px 12px; border-radius:12px; border:1px solid #d0d0e0; background:#fff; }
    button.primary { background:#0d6efd; color:#fff; border-color:#0d6efd; }
    #reader { width: 100%; max-width: 420px; margin: 14px auto; background:#000; border-radius: 16px; overflow:hidden; }
    .log { background:#fff; border:1px solid #e7e7f0; border-radius:16px; padding:14px; box-shadow:0 2px 8px rgba(0,0,0,.04); }
    .row { display:flex; justify-content:space-between; gap:8px; border-bottom:1px dashed #eee; padding:8px 0; font-size:14px; }
    .row:last-child { border-bottom:none; }
    .status { text-align:center; min-height: 24px; }
  </style>
</head>
<body>
  <h1>🚌 Bus QR Scanner</h1>

  <div class="toolbar">
    <label for="bus"><strong>Bus:</strong></label>
    <select id="bus">
      <option value="Bus01">Bus 01</option>
      <option value="Bus02">Bus 02</option>
      <option value="Bus03">Bus 03</option>
      <option value="Bus04">Bus 04</option>
      <option value="Bus05">Bus 05</option>
      <option value="Bus06">Bus 06</option>
      <option value="Bus07">Bus 07</option>
      <option value="Bus08">Bus 08</option>
      <option value="Bus09">Bus 09</option>
      <option value="Bus10">Bus 10</option>
      <option value="Bus11">Bus 11</option>
      <option value="Bus12">Bus 12</option>
    </select>
    <button id="toDashboard">Open Dashboard</button>
  </div>

  <div id="reader"></div>
  <div class="status" id="status"></div>

  <div class="log" id="log"></div>

  <!-- Libs -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // Firebase
    const firebaseConfig = {
            apiKey: "AIzaSyDSCJUwOe_MxqS_8SPfEmhZ4p_MOigXKyY",
            authDomain: "bus-monitor-7195d.firebaseapp.com",
            projectId: "bus-monitor-7195d",
            storageBucket: "bus-monitor-7195d.firebasestorage.app",
            messagingSenderId: "827570613765",
            appId: "1:827570613765:web:5ed5f2635174e3379f366c"
        };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const busSel = document.getElementById('bus');
    const statusDiv = document.getElementById('status');
    const logDiv = document.getElementById('log');
    const toDashboard = document.getElementById('toDashboard');
    toDashboard.onclick = () => window.location.href = 'dashboard_persistent_qr.html';

    function msg(html, cls) {
      statusDiv.className = 'status ' + (cls || '');
      statusDiv.innerHTML = html;
    }
    function logLine(text) {
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = `<span>${new Date().toLocaleTimeString()}</span><span>${text}</span>`;
      logDiv.prepend(row);
    }

    async function markBoarding(bus, qrText) {
      const attendeeRef = db.collection('buses').doc(bus).collection('attendees').doc(qrText);
      const doc = await attendeeRef.get();
      if (!doc.exists) {
        msg('❌ Not in uploaded list', 'error');
        logLine(`Unknown QR: ${qrText}`);
        return;
      }
      const data = doc.data();
      await attendeeRef.set({
        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
        boarded: true
      }, { merge: true });

      await db.collection('buses').doc(bus).collection('logs').add({
        qr: qrText,
        name: data.name || null,
        ts: firebase.firestore.FieldValue.serverTimestamp(),
        event: 'boarded'
      });

      msg(`✅ ${data.name || 'Passenger'} boarded ${bus}`, 'success');
      logLine(`Boarded: ${data.name || 'Passenger'} (${qrText})`);
    }

    function onScanSuccess(decodedText) {
      const bus = busSel.value;
      const qrText = (decodedText || '').trim();
      if (!qrText) return;
      markBoarding(bus, qrText).catch(e => {
        msg('❌ ' + e.message, 'error');
      });
    }

    const html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 280 },
      onScanSuccess
    ).catch(err => {
      msg('Camera error: ' + err.message, 'error');
      console.error(err);
    });
  </script>
</body>
</html>
